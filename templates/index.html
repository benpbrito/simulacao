<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Fila - ApexCharts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body {
      background: #f8f9fa;
    }
    .dashboard-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    .chart-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .total-value {
      font-size: 1.4rem;
      font-weight: bold;
    }
    .slider-container {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="mb-4">üìä Dashboard de Simula√ß√£o de Fila - TechService</h2>

    <div class="mb-4">
      <button class="btn btn-primary" id="toggleParametros">üéõÔ∏è Mostrar/Esconder Par√¢metros</button>
    </div>

    <div class="slider-container" id="parametros" style="display:none;">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="taxaChegada" class="form-label">Taxa de Chegada (clientes/hora)</label>
          <input type="range" class="form-range" min="5" max="60" value="30" id="taxaChegada">
          <div><span id="taxaChegadaVal">30</span> clientes/hora</div>
        </div>
        <div class="col-md-3">
          <label for="tempoAtendimento" class="form-label">Tempo M√©dio de Atendimento (min)</label>
          <input type="range" class="form-range" min="5" max="20" value="10" id="tempoAtendimento">
          <div><span id="tempoAtendimentoVal">10</span> minutos</div>
        </div>
        <div class="col-md-3">
          <label for="guiches" class="form-label">N√∫mero de Guich√™s</label>
          <input type="range" class="form-range" min="1" max="5" value="2" id="guiches">
          <div><span id="guichesVal">2</span> guich√™s</div>
        </div>
        <div class="col-md-3">
          <label for="taxaDesistencia" class="form-label">Taxa de Desist√™ncia (%)</label>
          <input type="range" class="form-range" min="0" max="50" value="15" id="taxaDesistencia">
          <div><span id="taxaDesistenciaVal">15</span>%</div>
        </div>
      </div>
    </div>

    <button class="btn btn-success mb-4" id="rodarSimulacao">‚ñ∂Ô∏è Rodar Simula√ß√£o</button>

    <div class="row g-4">
      <div class="col-md-3">
        <div class="dashboard-card">
          <div class="chart-title">Clientes Chegando</div>
          <div id="clientesChegando"></div>
          <div>Total: <span id="totalChegando" class="total-value">0</span></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="dashboard-card">
          <div class="chart-title">Clientes Atendidos</div>
          <div id="clientesAtendidos"></div>
          <div>Total: <span id="totalAtendidos" class="total-value">0</span></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="dashboard-card">
          <div class="chart-title">Clientes Desistentes</div>
          <div id="clientesDesistentes"></div>
          <div>Total: <span id="totalDesistentes" class="total-value">0</span></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="dashboard-card">
          <div class="chart-title">M√©dia de Espera (min)</div>
          <div id="mediaEspera"></div>
        </div>
      </div>
    </div>

    <div class="row mt-5">
      <div class="col-md-6">
        <div class="dashboard-card">
          <div class="chart-title">Resumo Total do Dia</div>
          <div id="graficoCircular"></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="dashboard-card">
          <div class="chart-title">Evolu√ß√£o Geral</div>
          <div id="graficoGeral"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const toggleBtn = document.getElementById("toggleParametros");
    const parametrosDiv = document.getElementById("parametros");
    toggleBtn.addEventListener("click", () => {
      parametrosDiv.style.display = parametrosDiv.style.display === "none" ? "block" : "none";
    });

    const sliders = ["taxaChegada", "tempoAtendimento", "guiches", "taxaDesistencia"];
    sliders.forEach(id => {
      const slider = document.getElementById(id);
      const label = document.getElementById(id + "Val");
      slider.addEventListener("input", () => {
        label.textContent = slider.value;
      });
    });

    // Inicializa gr√°ficos com dados vazios
    let chartClientesChegando, chartClientesAtendidos, chartClientesDesistentes, chartMediaEspera, chartGraficoCircular, chartGraficoGeral;

    function criarGraficoLinha(selector, titulo, cor) {
      return new ApexCharts(document.querySelector(selector), {
        chart: {
          type: 'area',
          height: 160,
          sparkline: { enabled: true },
        },
        stroke: { curve: 'smooth' },
        series: [{ name: titulo, data: [] }],
        colors: [cor],
        tooltip: { fixed: { enabled: false }, x: { show: false }, y: { title: { formatter: () => '' } }, marker: { show: false } }
        });
    }
    function criarGraficoDonut(selector) {
  return new ApexCharts(document.querySelector(selector), {
    chart: { type: 'donut', height: 300 },
    labels: ['Chegaram', 'Atendidos', 'Desistiram'],
    series: [],
    colors: ['#3498db', '#28a745', '#dc3545'],
    legend: { position: 'bottom' }
  });
}

function criarGraficoLinhaGeral(selector) {
  return new ApexCharts(document.querySelector(selector), {
    chart: { type: 'line', height: 300 },
    stroke: { curve: 'smooth', width: 3 },
    series: [],
    xaxis: { categories: [], title: { text: 'Tempo (minutos)' } },
    yaxis: { title: { text: 'Quantidade / Tempo M√©dio (min)' } },
    colors: ['#3498db', '#28a745', '#dc3545', '#f39c12']
  });
}

// Cria gr√°ficos e renderiza
chartClientesChegando = criarGraficoLinha("#clientesChegando", "Chegadas", "#3498db");
chartClientesAtendidos = criarGraficoLinha("#clientesAtendidos", "Atendidos", "#28a745");
chartClientesDesistentes = criarGraficoLinha("#clientesDesistentes", "Desistentes", "#dc3545");
chartMediaEspera = criarGraficoLinha("#mediaEspera", "Espera M√©dia", "#f39c12");

chartGraficoCircular = criarGraficoDonut("#graficoCircular");
chartGraficoGeral = criarGraficoLinhaGeral("#graficoGeral");

chartClientesChegando.render();
chartClientesAtendidos.render();
chartClientesDesistentes.render();
chartMediaEspera.render();
chartGraficoCircular.render();
chartGraficoGeral.render();

// Fun√ß√£o para atualizar gr√°ficos com dados do backend
function atualizarGraficos(data) {
  const stats = data.stats;
  const tempos = data.tempos;

  // Atualizar gr√°ficos pequenos
  chartClientesChegando.updateSeries([{ data: stats.clientes_chegando }]);
  chartClientesAtendidos.updateSeries([{ data: stats.clientes_atendidos }]);
  chartClientesDesistentes.updateSeries([{ data: stats.clientes_desistentes }]);
  chartMediaEspera.updateSeries([{ data: stats.media_espera }]);

  // Atualizar totais
  document.getElementById("totalChegando").textContent = stats.total_chegaram;
  document.getElementById("totalAtendidos").textContent = stats.total_atendidos;
  document.getElementById("totalDesistentes").textContent = stats.total_desistentes;

  // Atualizar gr√°fico donut
  chartGraficoCircular.updateSeries([stats.total_chegaram, stats.total_atendidos, stats.total_desistentes]);

  // Atualizar gr√°fico geral com todas as s√©ries
  chartGraficoGeral.updateOptions({
    xaxis: { categories: tempos }
  });
  chartGraficoGeral.updateSeries([
    { name: 'Chegando', data: stats.clientes_chegando },
    { name: 'Atendidos', data: stats.clientes_atendidos },
    { name: 'Desistentes', data: stats.clientes_desistentes },
    { name: 'Espera', data: stats.media_espera },
  ]);
}

// Enviar dados para o backend e receber resultados
document.getElementById("rodarSimulacao").addEventListener("click", () => {
  const params = {
    taxaChegada: document.getElementById("taxaChegada").value,
    tempoAtendimento: document.getElementById("tempoAtendimento").value,
    guiches: document.getElementById("guiches").value,
    taxaDesistencia: document.getElementById("taxaDesistencia").value / 100
  };

  fetch("/simular", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(params)
  })
  .then(res => res.json())
  .then(data => {
    atualizarGraficos(data);
  })
  .catch(err => console.error("Erro na simula√ß√£o:", err));
});
</script> </body> </html>
